Found a few bugs on the upgraded code.