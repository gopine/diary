Back to work.

Code refactor in progress, I spent 2 days looking into performance issue with this code.