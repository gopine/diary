Improved test coverage and fixed several bugs.